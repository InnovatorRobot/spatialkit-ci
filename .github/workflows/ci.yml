name: CI

on:
    push:
        branches: [main, develop]
    pull_request:
        branches: [main, develop]
    workflow_dispatch:

env:
    BUILD_TYPE: Release

jobs:
    build-and-test:
        name: Build and Test (${{ matrix.os }}, ${{ matrix.build_type }})
        runs-on: ${{ matrix.os }}
        strategy:
            fail-fast: false
            matrix:
                os: [ubuntu-latest, macos-latest]
                build_type: [Debug, Release]

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                  python-version: "3.10"

            - name: Install Python dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install numpy pillow

            - name: Install system dependencies (Ubuntu)
              if: matrix.os == 'ubuntu-latest'
              run: |
                  sudo apt-get update
                  sudo apt-get install -y \
                    build-essential \
                    cmake \
                    ninja-build \
                    libgl1-mesa-dev \
                    libglfw3-dev \
                    libglew-dev \
                    ccache \
                    pkg-config \
                    xvfb

            - name: Install system dependencies (macOS)
              if: matrix.os == 'macos-latest'
              run: |
                  brew install cmake ninja glew ccache

            - name: Configure ccache
              uses: actions/cache@v3
              with:
                  path: ~/.ccache
                  key: ${{ runner.os }}-ccache-${{ matrix.build_type }}-${{ hashFiles('**/CMakeLists.txt', '**/*.cpp', '**/*.h') }}
                  restore-keys: |
                      ${{ runner.os }}-ccache-${{ matrix.build_type }}-
                      ${{ runner.os }}-ccache-

            - name: Compile shaders
              run: |
                  python3 tools/shader_compiler.py --all --variant ${{ matrix.build_type == 'Debug' && 'debug' || 'release' }}

            - name: Configure CMake
              run: |
                  cmake -B build \
                    -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
                    -DBUILD_TESTS=ON \
                    -DBUILD_BENCHMARKS=ON \
                    -DENABLE_CCACHE=ON \
                    -G Ninja

            - name: Build
              run: |
                  cmake --build build --parallel $(nproc 2>/dev/null || sysctl -n hw.ncpu 2>/dev/null || echo 4)

            - name: Run unit tests
              if: matrix.os == 'ubuntu-latest'
              run: |
                  cd build
                  xvfb-run -a ctest --output-on-failure -T Test
              env:
                  DISPLAY: :99

            - name: Run unit tests (macOS)
              if: matrix.os == 'macos-latest'
              run: |
                  cd build
                  ctest --output-on-failure -T Test

            - name: Upload test results
              if: always()
              uses: actions/upload-artifact@v3
              with:
                  name: test-results-${{ matrix.os }}-${{ matrix.build_type }}
                  path: build/Testing/**/*.xml
                  if-no-files-found: ignore

    shader-compilation:
        name: Shader Compilation Validation
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                  python-version: "3.10"

            - name: Install Python dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install numpy pillow

            - name: Compile shaders (Release)
              run: |
                  python3 tools/shader_compiler.py --all --variant release
                  echo "Release shaders compiled successfully"

            - name: Compile shaders (Debug)
              run: |
                  python3 tools/shader_compiler.py --all --variant debug
                  echo "Debug shaders compiled successfully"

            - name: Verify shader outputs
              run: |
                  if [ ! -f "shaders/compiled/basic.vert" ] || [ ! -f "shaders/compiled/basic.frag" ]; then
                    echo "Error: Compiled shaders not found"
                    exit 1
                  fi
                  echo "Shader compilation validation passed"

    visual-regression:
        name: Visual Regression Tests
        runs-on: ubuntu-latest
        needs: build-and-test

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                  python-version: "3.10"

            - name: Install Python dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install numpy pillow

            - name: Install system dependencies
              run: |
                  sudo apt-get update
                  sudo apt-get install -y \
                    build-essential \
                    cmake \
                    ninja-build \
                    libgl1-mesa-dev \
                    libglfw3-dev \
                    libglew-dev \
                    xvfb

            - name: Compile shaders
              run: |
                  python3 tools/shader_compiler.py --all --variant release

            - name: Build
              run: |
                  cmake -B build -DCMAKE_BUILD_TYPE=Release -DBUILD_TESTS=ON -G Ninja
                  cmake --build build --parallel $(nproc)

            - name: Run visual regression tests
              run: |
                  cd build
                  xvfb-run -a ./tests/visual/spatialrender_visual_tests
              env:
                  DISPLAY: :99

            - name: Compare against golden images
              run: |
                  python3 tests/visual/visual_regression.py \
                    --output-dir build/tests/visual/output \
                    --golden-dir tests/visual/golden \
                    --threshold 0.01 || true

            - name: Upload visual test artifacts
              if: failure()
              uses: actions/upload-artifact@v3
              with:
                  name: visual-regression-failures
                  path: |
                      build/tests/visual/output/**
                      build/tests/visual/diffs/**
                  if-no-files-found: ignore

    performance-benchmarks:
        name: Performance Benchmarks
        runs-on: ubuntu-latest
        needs: build-and-test

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                  python-version: "3.10"

            - name: Install system dependencies
              run: |
                  sudo apt-get update
                  sudo apt-get install -y \
                    build-essential \
                    cmake \
                    ninja-build \
                    libgl1-mesa-dev \
                    libglfw3-dev \
                    libglew-dev \
                    xvfb

            - name: Compile shaders
              run: |
                  python3 tools/shader_compiler.py --all --variant release

            - name: Build
              run: |
                  cmake -B build -DCMAKE_BUILD_TYPE=Release -DBUILD_BENCHMARKS=ON -G Ninja
                  cmake --build build --parallel $(nproc)

            - name: Run benchmarks
              run: |
                  cd build
                  xvfb-run -a ./benchmarks/spatialrender_benchmark
              env:
                  DISPLAY: :99

            - name: Upload benchmark results
              uses: actions/upload-artifact@v3
              with:
                  name: benchmark-results
                  path: build/benchmarks/*.json
                  if-no-files-found: ignore

    code-quality:
        name: Code Quality Checks
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Install clang-format
              run: |
                  sudo apt-get update
                  sudo apt-get install -y clang-format

            - name: Check code formatting
              run: |
                  find renderer tests benchmarks -name '*.cpp' -o -name '*.h' | \
                    xargs clang-format --dry-run --Werror || {
                    echo "Code formatting check failed. Run 'clang-format -i' to fix."
                    exit 1
                  }

            - name: Check CMake formatting
              run: |
                  find . -name 'CMakeLists.txt' -not -path './build/*' | \
                    head -5  # Basic check, can be expanded
